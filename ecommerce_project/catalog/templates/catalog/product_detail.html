<!-- catalog/templates/catalog/product_detail.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - Ürün Detayı{% endblock %}

{% block content %}
<div class="row">
  <!-- Sol: Ürün Resimleri -->
  <div class="col-md-6">
    {# Ana Öne Çıkan Resim #}
    {% with img=product.get_featured_image %}
      {% if img %}
        <img id="mainImage" src="{{ img.image.url }}" class="img-fluid rounded" alt="{{ product.name }}">
      {% else %}
        <img id="mainImage" src="{% static 'img/no-image.png' %}" class="img-fluid rounded" alt="Resim yok">
      {% endif %}
    {% endwith %}

    {# Alt Resim Galerisi #}
    <div class="mt-3 d-flex flex-wrap">
      {% for thumb in product.images.all %}
        <img src="{{ thumb.image.url }}"
             alt="{{ product.name }} foto"
             class="img-thumbnail me-2 mb-2"
             style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;"
             onclick="document.getElementById('mainImage').src='{{ thumb.image.url }}'">
      {% endfor %}
    </div>
  </div>

  <!-- Sağ: Ürün Bilgileri -->
  <div class="col-md-6">
    <h3>{{ product.name }}</h3>
    <p class="text-muted">{{ product.category.name }}</p>
    <p>{{ product.description }}</p>

    <form method="get" id="addCartForm">
      <div class="mb-3">
        <label for="variantSelect" class="form-label">Seçenek:</label>
        <select name="variant" id="variantSelect" class="form-select" required>
          <option value="">-- Seçiniz --</option>
          {% for variant in product.variants.all %}
            <option value="{{ variant.id }}">{{ variant.variant_name }} - {{ variant.price|floatformat:2 }}₺</option>
          {% endfor %}
        </select>
      </div>
      <div class="mb-3">
        <label for="quantity" class="form-label">Adet:</label>
        <input type="number" id="quantity" name="quantity" value="1" min="1" class="form-control w-25">
      </div>

      {% if user.is_authenticated %}
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-cart-plus"></i> Sepete Ekle
        </button>
      {% else %}
        <p class="text-danger small">
          Ürünü favori ve sepete eklemek için lütfen <a href="{% url 'login' %}">giriş yapın</a>.
        </p>
      {% endif %}

      {% if user.is_authenticated %}
        <a href="{% url 'add_to_favorites' product.id %}" class="btn btn-outline-danger ms-2">
          <i class="bi bi-heart"></i> Favoriye Ekle
        </a>
      {% endif %}
    </form>

    {% block extra_js %}
      <script>
        // Sepete ekleme URL’sini dinamik ayarlamak için
        const addCartForm = document.getElementById('addCartForm');
        const variantSelect = document.getElementById('variantSelect');
        variantSelect.addEventListener('change', () => {
          const val = variantSelect.value;
          if (val) {
            addCartForm.action = `/cart/add/${val}/`;
          }
        });

        // Miktar ve seçilen varyanta göre toplam fiyat gösterimi (isteğe bağlı)
        const quantityInput = document.getElementById('quantity');
        function updateTotal() {
          const selectedOption = variantSelect.options[variantSelect.selectedIndex];
          if (!selectedOption.value) return;
          const priceText = selectedOption.text.split('-').pop().trim().replace('₺','');
          const unitPrice = parseFloat(priceText);
          const qty = parseInt(quantityInput.value) || 1;
          const total = (unitPrice * qty).toFixed(2);
          // Örneğin bir <span id="totalPrice"></span> alanı varsa:
          const totalSpan = document.getElementById('totalPrice');
          if (totalSpan) {
            totalSpan.innerText = total + '₺';
          }
        }
        variantSelect.addEventListener('change', updateTotal);
        quantityInput.addEventListener('input', updateTotal);
      </script>
    {% endblock %}
  </div>
</div>
{% endblock %}
